# SolarSDGs IoT - Claude Code å°ˆæ¡ˆè¨˜æ†¶æª”æ¡ˆ

> ğŸ¤– çµ¦ Claude Code ä½¿ç”¨çš„é–‹ç™¼æŒ‡å¼•èˆ‡è¦ç¯„  
> **ä½¿å‘½**: å”åŠ©å¾ Node-RED é·ç§»åˆ° Node.js + Vue.js | ä¿æŒç¨‹å¼ç¢¼å“è³ª | é¿å…å¸¸è¦‹éŒ¯èª¤

---

## ğŸš¨ æœ€é«˜å„ªå…ˆç´šè¦å‰‡ (CRITICAL)

### â›” ç¦æ­¢è‡ªå‹•å›æ»¾ (NEVER ROLLBACK)

**é‡è¦æ€§**: â­â­â­â­â­

Claude Code åœ¨é‡åˆ°ä»»ä½•éŒ¯èª¤æˆ–å•é¡Œæ™‚:

1. **âŒ çµ•å°ç¦æ­¢**: è‡ªå‹•å›æ»¾åˆ°èˆŠç‰ˆæœ¬
2. **âŒ çµ•å°ç¦æ­¢**: æœªç¶“ç¢ºèªå°±åˆªé™¤æˆ–ä¿®æ”¹ç¨‹å¼ç¢¼
3. **âŒ çµ•å°ç¦æ­¢**: è‡ªå‹•åŸ·è¡Œ `git reset` æˆ– `git checkout` ç­‰é‚„åŸæŒ‡ä»¤
4. **âœ… å¿…é ˆåš**: å ±å‘ŠéŒ¯èª¤ä¸¦åœæ­¢æ“ä½œ
5. **âœ… å¿…é ˆåš**: æä¾› 3-5 å€‹å¯èƒ½çš„ä¿®å¾©æ–¹æ¡ˆ
6. **âœ… å¿…é ˆåš**: ç­‰å¾…ç”¨æˆ¶æ˜ç¢ºé¸æ“‡å¾Œå†ç¹¼çºŒ

### â›” ç¦æ­¢æœªç¶“åŒæ„å‰µå»ºè…³æœ¬æˆ–æ–‡ä»¶ (NEVER CREATE WITHOUT PERMISSION)

**é‡è¦æ€§**: â­â­â­â­â­

Claude Code åœ¨å‰µå»ºæ–°æ–‡ä»¶æˆ–è…³æœ¬æ™‚:

1. **âŒ çµ•å°ç¦æ­¢**: æœªç¶“ç”¨æˆ¶æ˜ç¢ºåŒæ„å°±å‰µå»ºæ–°çš„è…³æœ¬æ–‡ä»¶
2. **âŒ çµ•å°ç¦æ­¢**: è‡ªå‹•ç”Ÿæˆå¤šå€‹ã€Œè¼”åŠ©å·¥å…·ã€æˆ–ã€Œéƒ¨ç½²è…³æœ¬ã€
3. **âŒ çµ•å°ç¦æ­¢**: å‰µå»ºç”¨æˆ¶æ²’æœ‰è¦æ±‚çš„ã€Œä¾¿åˆ©å·¥å…·ã€
4. **âœ… å¿…é ˆåš**: å…ˆè©¢å•ç”¨æˆ¶æ˜¯å¦éœ€è¦å‰µå»ºè©²æ–‡ä»¶
5. **âœ… å¿…é ˆåš**: èªªæ˜ç‚ºä»€éº¼éœ€è¦é€™å€‹æ–‡ä»¶
6. **âœ… å¿…é ˆåš**: ç­‰å¾…ç”¨æˆ¶æ˜ç¢ºåŒæ„å¾Œæ‰å‰µå»º

**æ­£ç¢ºæµç¨‹**:
```
éœ€è¦æ–°æ–‡ä»¶ â†’ èªªæ˜åŸå›  â†’ è©¢å•ç”¨æˆ¶ â†’ ç­‰å¾…åŒæ„ â†’ å‰µå»ºæ–‡ä»¶
```

**ç”¨æˆ¶åå¥½**:
- ç”¨æˆ¶å¸Œæœ›è‡ªå·± 100% æ§åˆ¶æ‰€æœ‰æ–‡ä»¶çš„å‰µå»º
- å¦‚éœ€å®‰è£ä¾è³´ï¼Œç›´æ¥é€£æ¥ VPS åŸ·è¡Œå‘½ä»¤ï¼Œä¸è¦å‰µå»ºè…³æœ¬
- ç›¡é‡ä½¿ç”¨ç¾æœ‰å·¥å…·å’Œç›´æ¥åŸ·è¡Œï¼Œè€Œéå‰µå»ºæ–°è…³æœ¬

**éŒ¯èª¤è™•ç†æµç¨‹**:
```
é‡åˆ°éŒ¯èª¤ â†’ åœæ­¢ â†’ åˆ†æåŸå›  â†’ æä¾›æ–¹æ¡ˆ â†’ ç­‰å¾…ç¢ºèª â†’ åŸ·è¡Œä¿®å¾©
```

**ç¤ºç¯„**:
```
âŒ éŒ¯èª¤:
"ç·¨è­¯å¤±æ•—,è®“æˆ‘å›æ»¾åˆ°ä¸Šå€‹ç‰ˆæœ¬..."

âœ… æ­£ç¢º:
"ç·¨è­¯å¤±æ•—ã€‚éŒ¯èª¤: Cannot find module 'xxx'

å¯èƒ½çš„ä¿®å¾©æ–¹æ¡ˆ:
1. å®‰è£ç¼ºå°‘çš„ä¾è³´: npm install xxx
2. æª¢æŸ¥ import è·¯å¾‘æ˜¯å¦æ­£ç¢º
3. æ¸…ç† node_modules ä¸¦é‡æ–°å®‰è£

è«‹é¸æ“‡ä¿®å¾©æ–¹æ¡ˆ?"
```

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ§‹åŸå‰‡

### 1. **åˆ†å±¤æ¶æ§‹å¿…é ˆåš´æ ¼éµå®ˆ**

```
Controller (è·¯ç”±å±¤)
    â†“ å‘¼å«
Service (æ¥­å‹™é‚è¼¯å±¤)
    â†“ å‘¼å«
Repository (è³‡æ–™è¨ªå•å±¤)
    â†“ å‘¼å«
Database (PostgreSQL)
```

**è¦å‰‡**:
- âœ… Controller åªè™•ç†: HTTP è«‹æ±‚/éŸ¿æ‡‰ã€åƒæ•¸é©—è­‰ã€å‘¼å« Service
- âœ… Service è™•ç†: æ¥­å‹™é‚è¼¯ã€æ•¸æ“šè½‰æ›ã€å”èª¿å¤šå€‹ Repository
- âœ… Repository è™•ç†: SQL æŸ¥è©¢ã€è³‡æ–™åº«æ“ä½œ
- âŒ ç¦æ­¢è·¨å±¤å‘¼å« (ä¾‹å¦‚: Controller ç›´æ¥å‘¼å« Repository)
- âŒ ç¦æ­¢åœ¨ Controller ä¸­å¯«æ¥­å‹™é‚è¼¯
- âŒ ç¦æ­¢åœ¨ Repository ä¸­å¯«æ¥­å‹™é‚è¼¯

### 2. **å¾ Node-RED åˆ° Node.js çš„å°æ‡‰é—œä¿‚**

| Node-RED ç¯€é» | Node.js å¯¦ç¾ | æª”æ¡ˆè·¯å¾‘ |
|--------------|-------------|---------|
| MQTT In | `MqttService.subscribe()` | `backend/src/services/mqtt/MqttService.ts` |
| æ•¸æ“šè§£æå™¨ Function | `DataParser.parse()` | `backend/src/services/mqtt/DataParser.ts` |
| GPS è§£æå™¨ Function | `GpsParser.parse()` | `backend/src/services/mqtt/GpsParser.ts` |
| SQLç”Ÿæˆå™¨ Function | `SqlGenerator.generate()` | `backend/src/services/database/SqlGenerator.ts` |
| PostgreSQL ç¯€é» | `PowerDataRepository` | `backend/src/services/database/PowerDataRepo.ts` |
| é…ç½®åŒæ­¥å™¨ Function | `ConfigSync.sync()` | `backend/src/services/device/ConfigSync.ts` |
| æ ¼å¼åŒ–UIæ•¸æ“š Function | `UiFormatter.format()` | `backend/src/services/realtime/UiFormatter.ts` |
| MQTT Out | `MqttService.publish()` | `backend/src/services/mqtt/MqttService.ts` |
| Dashboard Template | Vue Components | `frontend/src/components/` |
| **åœ–åƒä¸Šå‚³è™•ç†** (æ–°å¢) | `ImageService.upload()` | `backend/src/services/image/ImageService.ts` |
| **CSV åŒ¯å‡º** (æ–°å¢) | `CsvExporter.export()` | `backend/src/services/database/CsvExporter.ts` |

**é‡è¦**: æ¯å€‹ Node-RED Function ç¯€é»éƒ½æ‡‰è©²è½‰æ›æˆå°æ‡‰çš„ TypeScript class æˆ– function

### 3. **æ–°å¢åŠŸèƒ½æ¶æ§‹ (2025-11-13)**

#### åœ–åƒç›£æ§ç³»çµ±
- **Pi Zero 2W è‡ªå‹•æ‹æ”**: æ¯ 10 åˆ†é˜æ‹æ” RGB + ç†±å½±åƒåœ–
- **åœ–åƒä¸Šå‚³**: HTTP POST multipart/form-data
- **åœ–åƒè™•ç†**: Sharp (å£“ç¸®ã€ç¸®åœ–ç”Ÿæˆã€æ ¼å¼è½‰æ›)
- **å„²å­˜æ¶æ§‹**: æª”æ¡ˆç³»çµ± + PostgreSQL å…ƒæ•¸æ“š
- **å‰ç«¯æª¢è¦–**: Viewerjs (ç¸®æ”¾ã€å…¨è¢å¹•ã€æ™‚é–“è»¸)

#### æ•¸æ“šåŒ¯å‡ºç³»çµ±
- **åŒ¯å‡ºæ ¼å¼**: åƒ…æ”¯æ´ CSV (ä¸æ”¯æ´ Excel/PDF)
- **åŒ¯å‡ºå…§å®¹**: åŠŸç‡æ•¸æ“šã€GPS æ•¸æ“šã€è¨­å‚™ç‹€æ…‹
- **å‰ç«¯è™•ç†**: PapaParse (CSV è§£æ) + file-saver (ä¸‹è¼‰)

#### åœ–è¡¨å¢å¼·åŠŸèƒ½
- **ç¸®æ”¾èˆ‡å¹³ç§»**: chartjs-plugin-zoom
- **è¨»é‡‹æ¨™è¨˜**: chartjs-plugin-annotation
- **æ™‚é–“è»¸**: chartjs-adapter-dayjs-4

---

## ğŸ”§ é–‹ç™¼è¦ç¯„é€ŸæŸ¥è¡¨

### TypeScript è¦ç¯„

```typescript
// âœ… æ­£ç¢º: æ˜ç¢ºçš„é¡å‹å®šç¾©
interface PowerData {
  device_id: string;
  timestamp: Date;
  pg: number;
  pa: number;
  pp: number;
  pag?: number;
  ppg?: number;
}

// âœ… æ­£ç¢º: async/await
async function fetchData(): Promise<PowerData[]> {
  const result = await repository.findAll();
  return result;
}

// âŒ éŒ¯èª¤: ä½¿ç”¨ any
function process(data: any) { }  // âŒ

// âŒ éŒ¯èª¤: ä½¿ç”¨ callback
function getData(cb: Function) { }  // âŒ
```

### å‘½åè¦ç¯„

```typescript
// âœ… æª”æ¡ˆå‘½å
MqttService.ts          // PascalCase (é¡åˆ¥)
powerData.types.ts      // camelCase (é¡å‹å®šç¾©)
use-websocket.ts        // kebab-case (composable)

// âœ… è®Šæ•¸å‘½å
const deviceId = '6001';           // camelCase (è®Šæ•¸)
const API_URL = 'https://...';     // UPPER_SNAKE_CASE (å¸¸æ•¸)
class PowerDataService { }         // PascalCase (é¡åˆ¥)
function calculateEfficiency() { } // camelCase (å‡½æ•¸)

// âŒ éŒ¯èª¤å‘½å
const device_id = '6001';     // âŒ ä¸ç”¨ snake_case
const apiUrl = 'https://...'; // âŒ å¸¸æ•¸æ‡‰è©²å¤§å¯«
class powerDataService { }    // âŒ é¡åˆ¥æ‡‰è©² PascalCase
```

### éŒ¯èª¤è™•ç†è¦ç¯„

```typescript
// âœ… æ­£ç¢º: çµ±ä¸€çš„éŒ¯èª¤é¡åˆ¥
export class AppError extends Error {
  constructor(
    public statusCode: number,
    public message: string,
    public isOperational = true
  ) {
    super(message);
  }
}

// âœ… æ­£ç¢º: try-catch
try {
  const result = await service.create(data);
  return result;
} catch (error) {
  if (error instanceof AppError) {
    throw error;
  }
  throw new AppError(500, 'Internal server error');
}

// âŒ éŒ¯èª¤: æ‹‹å‡ºå­—ä¸²
throw 'Error occurred';  // âŒ

// âŒ éŒ¯èª¤: ä¸è™•ç†éŒ¯èª¤
const result = await service.create(data);  // âŒ æ²’æœ‰ try-catch
```

---

## ğŸ“ ç¨‹å¼ç¢¼æ’°å¯«ç¯„æœ¬

### å¾Œç«¯ Service ç¯„æœ¬

```typescript
// backend/src/services/[domain]/[Name]Service.ts

import { Injectable } from '@nestjs/common';  // å¦‚æœä½¿ç”¨ NestJS
import { AppError } from '@/utils/errors';
import { Logger } from '@/utils/logger';

export class PowerDataService {
  private readonly logger = new Logger(PowerDataService.name);

  constructor(
    private readonly powerDataRepo: PowerDataRepository,
    private readonly mqttService: MqttService
  ) {}

  /**
   * å‰µå»ºåŠŸç‡æ•¸æ“š
   * @param data åŠŸç‡æ•¸æ“š
   * @returns å‰µå»ºçš„æ•¸æ“š
   * @throws AppError å¦‚æœé©—è­‰å¤±æ•—æˆ–å„²å­˜å¤±æ•—
   */
  async createPowerData(data: CreatePowerDataDto): Promise<PowerData> {
    // 1. é©—è­‰
    this.validatePowerData(data);
    
    // 2. æ¥­å‹™é‚è¼¯
    const efficiency = this.calculateEfficiency(data);
    
    // 3. å„²å­˜
    const saved = await this.powerDataRepo.insert({
      ...data,
      ...efficiency
    });
    
    // 4. å¾ŒçºŒæ“ä½œ
    await this.mqttService.sendAck(data.device_id, saved.id);
    
    this.logger.info(`Created power data for device ${data.device_id}`);
    return saved;
  }

  private validatePowerData(data: CreatePowerDataDto): void {
    if (data.pg < 0 || data.pg > 10000) {
      throw new AppError(400, 'PG must be between 0 and 10000');
    }
    // ... å…¶ä»–é©—è­‰
  }

  private calculateEfficiency(data: CreatePowerDataDto) {
    const pag = data.pg > 0 ? ((data.pa - data.pg) / data.pg) * 100 : 0;
    const ppg = data.pg > 0 ? ((data.pp - data.pg) / data.pg) * 100 : 0;
    return { pag, ppg };
  }
}
```

### å‰ç«¯ Composable ç¯„æœ¬

```typescript
// frontend/src/composables/usePowerData.ts

import { ref, computed } from 'vue';
import { powerDataApi } from '@/services/powerDataApi';
import type { PowerData } from '@/types/power.types';

export function usePowerData() {
  // State
  const data = ref<PowerData[]>([]);
  const loading = ref(false);
  const error = ref<string | null>(null);

  // Computed
  const latestData = computed(() => {
    return data.value.length > 0 
      ? data.value[data.value.length - 1] 
      : null;
  });

  const avgPower = computed(() => {
    if (data.value.length === 0) return 0;
    const sum = data.value.reduce((acc, item) => acc + item.pg, 0);
    return sum / data.value.length;
  });

  // Methods
  async function fetchData(deviceId: string) {
    loading.value = true;
    error.value = null;
    
    try {
      const response = await powerDataApi.getByDevice(deviceId);
      data.value = response.data;
    } catch (err: any) {
      error.value = err.message || 'Failed to fetch data';
      console.error('Error fetching power data:', err);
    } finally {
      loading.value = false;
    }
  }

  function clearData() {
    data.value = [];
    error.value = null;
  }

  return {
    // State
    data,
    loading,
    error,
    
    // Computed
    latestData,
    avgPower,
    
    // Methods
    fetchData,
    clearData
  };
}
```

### Vue çµ„ä»¶ç¯„æœ¬

```vue
<!-- frontend/src/components/dashboard/PowerCard.vue -->

<script setup lang="ts">
import { computed } from 'vue';

interface Props {
  label: string;
  value: number;
  unit?: string;
  color?: string;
}

const props = withDefaults(defineProps<Props>(), {
  unit: 'W',
  color: '#3498db'
});

const emit = defineEmits<{
  (e: 'click'): void
}>();

const displayValue = computed(() => {
  return props.value.toFixed(2);
});

const cardStyle = computed(() => ({
  borderColor: props.color
}));
</script>

<template>
  <div class="power-card" :style="cardStyle" @click="emit('click')">
    <div class="power-card__label">{{ label }}</div>
    <div class="power-card__value">
      {{ displayValue }}
      <span class="power-card__unit">{{ unit }}</span>
    </div>
  </div>
</template>

<style scoped>
.power-card {
  padding: 20px;
  border: 2px solid;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
}

.power-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.power-card__label {
  font-size: 14px;
  color: #666;
  margin-bottom: 8px;
}

.power-card__value {
  font-size: 32px;
  font-weight: bold;
}

.power-card__unit {
  font-size: 16px;
  font-weight: normal;
  margin-left: 4px;
}
</style>
```

---

## ğŸ“ æ–°å¢åŠŸèƒ½ç¨‹å¼ç¢¼ç¯„æœ¬ (2025-11-13)

### åœ–åƒä¸Šå‚³æœå‹™ç¯„æœ¬

```typescript
// backend/src/services/image/ImageService.ts

import sharp from 'sharp';
import { v4 as uuidv4 } from 'uuid';
import path from 'path';
import fs from 'fs/promises';
import { AppError } from '@/utils/errors';
import { Logger } from '@/utils/logger';
import type { ImageRepo } from '@/services/database/ImageRepo';

interface UploadedImage {
  deviceId: string;
  rgbImage: Express.Multer.File;
  thermalImage: Express.Multer.File;
  capturedAt: Date;
}

export class ImageService {
  private readonly logger = new Logger(ImageService.name);
  private readonly uploadDir = path.join(__dirname, '../../../uploads/images');

  constructor(private readonly imageRepo: ImageRepo) {}

  /**
   * è™•ç†åœ–åƒä¸Šå‚³ï¼ˆRGB + ç†±å½±åƒï¼‰
   */
  async uploadImages(data: UploadedImage) {
    try {
      // 1. ç”Ÿæˆå”¯ä¸€ ID
      const imageId = uuidv4();

      // 2. å„²å­˜åŸå§‹åœ–åƒ
      const rgbPath = await this.saveImage(data.rgbImage, imageId, 'rgb');
      const thermalPath = await this.saveImage(data.thermalImage, imageId, 'thermal');

      // 3. ç”Ÿæˆç¸®åœ–
      const rgbThumbPath = await this.generateThumbnail(rgbPath, imageId, 'rgb');
      const thermalThumbPath = await this.generateThumbnail(thermalPath, imageId, 'thermal');

      // 4. å„²å­˜å…ƒæ•¸æ“šåˆ°è³‡æ–™åº«
      const saved = await this.imageRepo.insert({
        deviceId: data.deviceId,
        rgbImagePath: rgbPath,
        thermalImagePath: thermalPath,
        rgbThumbnailPath: rgbThumbPath,
        thermalThumbnailPath: thermalThumbPath,
        rgbFileSize: data.rgbImage.size,
        thermalFileSize: data.thermalImage.size,
        capturedAt: data.capturedAt
      });

      this.logger.info(`Images uploaded for device ${data.deviceId}`);
      return saved;

    } catch (error) {
      this.logger.error('Failed to upload images:', error);
      throw new AppError(500, 'Failed to upload images');
    }
  }

  /**
   * å„²å­˜åœ–åƒæª”æ¡ˆ
   */
  private async saveImage(
    file: Express.Multer.File,
    imageId: string,
    type: 'rgb' | 'thermal'
  ): Promise<string> {
    const dir = path.join(this.uploadDir, type);
    await fs.mkdir(dir, { recursive: true });

    const filename = `${imageId}.jpg`;
    const filepath = path.join(dir, filename);

    // ä½¿ç”¨ Sharp å£“ç¸®ä¸¦å„²å­˜
    await sharp(file.buffer)
      .jpeg({ quality: 85 })
      .toFile(filepath);

    return `/uploads/images/${type}/${filename}`;
  }

  /**
   * ç”Ÿæˆç¸®åœ–
   */
  private async generateThumbnail(
    imagePath: string,
    imageId: string,
    type: 'rgb' | 'thermal'
  ): Promise<string> {
    const dir = path.join(this.uploadDir, 'thumbnails', type);
    await fs.mkdir(dir, { recursive: true });

    const filename = `${imageId}_thumb.jpg`;
    const filepath = path.join(dir, filename);

    const fullPath = path.join(__dirname, '../../..', imagePath);

    await sharp(fullPath)
      .resize(320, 240, { fit: 'cover' })
      .jpeg({ quality: 80 })
      .toFile(filepath);

    return `/uploads/images/thumbnails/${type}/${filename}`;
  }
}
```

### CSV åŒ¯å‡ºæœå‹™ç¯„æœ¬

```typescript
// backend/src/services/database/CsvExporter.ts

import { createObjectCsvWriter } from 'csv-writer';
import path from 'path';
import { AppError } from '@/utils/errors';
import { Logger } from '@/utils/logger';
import type { PowerDataRepo } from './PowerDataRepo';

export class CsvExporter {
  private readonly logger = new Logger(CsvExporter.name);
  private readonly exportDir = path.join(__dirname, '../../../exports');

  constructor(private readonly powerDataRepo: PowerDataRepo) {}

  /**
   * åŒ¯å‡ºåŠŸç‡æ•¸æ“šç‚º CSV
   */
  async exportPowerData(
    deviceId: string,
    startDate: Date,
    endDate: Date
  ): Promise<string> {
    try {
      // 1. æŸ¥è©¢æ•¸æ“š
      const data = await this.powerDataRepo.findByDateRange(
        deviceId,
        startDate,
        endDate
      );

      if (data.length === 0) {
        throw new AppError(404, 'No data found for the specified date range');
      }

      // 2. å»ºç«‹ CSV Writer
      const filename = `power_data_${deviceId}_${Date.now()}.csv`;
      const filepath = path.join(this.exportDir, filename);

      const csvWriter = createObjectCsvWriter({
        path: filepath,
        header: [
          { id: 'timestamp', title: 'Timestamp' },
          { id: 'deviceId', title: 'Device ID' },
          { id: 'pg', title: 'PG (W)' },
          { id: 'pa', title: 'PA (W)' },
          { id: 'pp', title: 'PP (W)' },
          { id: 'pag', title: 'PAG Efficiency (%)' },
          { id: 'ppg', title: 'PPG Efficiency (%)' }
        ]
      });

      // 3. å¯«å…¥æ•¸æ“š
      await csvWriter.writeRecords(data);

      this.logger.info(`CSV exported: ${filename}`);
      return filepath;

    } catch (error) {
      this.logger.error('Failed to export CSV:', error);
      throw new AppError(500, 'Failed to export CSV');
    }
  }
}
```

### å‰ç«¯åœ–åƒæª¢è¦–å™¨ Composable

```typescript
// frontend/src/composables/useImageViewer.ts

import { ref } from 'vue';
import { api as viewerApi } from 'v-viewer';
import type { ImageData } from '@/types/image.types';

export function useImageViewer() {
  const images = ref<ImageData[]>([]);
  const currentIndex = ref(0);

  /**
   * é–‹å•Ÿåœ–åƒæª¢è¦–å™¨
   */
  function showImage(imageList: ImageData[], index: number = 0) {
    images.value = imageList;
    currentIndex.value = index;

    const imageUrls = imageList.map(img => ({
      url: img.rgbImagePath,
      title: `${img.deviceId} - ${new Date(img.capturedAt).toLocaleString()}`
    }));

    viewerApi({
      images: imageUrls.map(img => img.url),
      options: {
        initialViewIndex: index,
        toolbar: true,
        navbar: true,
        title: true,
        keyboard: true,
        zoomRatio: 0.2
      }
    });
  }

  /**
   * æ¯”è¼ƒ RGB èˆ‡ç†±å½±åƒ
   */
  function compareImages(image: ImageData) {
    const imageUrls = [
      { url: image.rgbImagePath, title: 'RGB Image' },
      { url: image.thermalImagePath, title: 'Thermal Image' }
    ];

    viewerApi({
      images: imageUrls.map(img => img.url),
      options: {
        toolbar: true,
        navbar: true,
        title: true
      }
    });
  }

  return {
    images,
    currentIndex,
    showImage,
    compareImages
  };
}
```

### å‰ç«¯ CSV åŒ¯å‡º Composable

```typescript
// frontend/src/composables/useCsvExport.ts

import { ref } from 'vue';
import { saveAs } from 'file-saver';
import Papa from 'papaparse';
import type { PowerData } from '@/types/power.types';

export function useCsvExport() {
  const exporting = ref(false);
  const error = ref<string | null>(null);

  /**
   * åŒ¯å‡ºåŠŸç‡æ•¸æ“šç‚º CSV
   */
  function exportPowerData(data: PowerData[], filename: string = 'power_data.csv') {
    exporting.value = true;
    error.value = null;

    try {
      // 1. æº–å‚™æ•¸æ“š
      const exportData = data.map(item => ({
        'Timestamp': new Date(item.timestamp).toLocaleString(),
        'Device ID': item.deviceId,
        'PG (W)': item.pg,
        'PA (W)': item.pa,
        'PP (W)': item.pp,
        'PAG Efficiency (%)': item.pagEfficiency?.toFixed(2) || 'N/A',
        'PPG Efficiency (%)': item.ppgEfficiency?.toFixed(2) || 'N/A'
      }));

      // 2. è½‰æ›ç‚º CSV
      const csv = Papa.unparse(exportData);

      // 3. ä¸‹è¼‰æª”æ¡ˆ
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      saveAs(blob, filename);

      console.log(`CSV exported: ${filename}`);

    } catch (err: any) {
      error.value = err.message || 'Failed to export CSV';
      console.error('CSV export error:', err);
    } finally {
      exporting.value = false;
    }
  }

  return {
    exporting,
    error,
    exportPowerData
  };
}
```

---

## âš ï¸ å¸¸è¦‹éŒ¯èª¤èˆ‡è§£æ±ºæ–¹æ¡ˆ

### éŒ¯èª¤ 1: åœ¨ Controller å¯«æ¥­å‹™é‚è¼¯

```typescript
// âŒ éŒ¯èª¤
class PowerDataController {
  async create(req, res) {
    const { pg, pa, pp } = req.body;
    
    // âŒ æ¥­å‹™é‚è¼¯ä¸æ‡‰è©²åœ¨é€™è£¡
    const pag = ((pa - pg) / pg) * 100;
    const ppg = ((pp - pg) / pg) * 100;
    
    await db.query('INSERT INTO ...');
    res.json({ success: true });
  }
}

// âœ… æ­£ç¢º
class PowerDataController {
  async create(req, res) {
    // âœ… åªè² è²¬å‘¼å« Service
    const result = await this.powerDataService.createPowerData(req.body);
    res.json(result);
  }
}
```

### éŒ¯èª¤ 2: å¿˜è¨˜éŒ¯èª¤è™•ç†

```typescript
// âŒ éŒ¯èª¤
async function getData() {
  const result = await api.fetch();  // âŒ æ²’æœ‰éŒ¯èª¤è™•ç†
  return result;
}

// âœ… æ­£ç¢º
async function getData() {
  try {
    const result = await api.fetch();
    return result;
  } catch (error) {
    logger.error('Failed to fetch data:', error);
    throw new AppError(500, 'Failed to fetch data');
  }
}
```

### éŒ¯èª¤ 3: ä½¿ç”¨ any é¡å‹

```typescript
// âŒ éŒ¯èª¤
function process(data: any) {  // âŒ 
  return data.value;
}

// âœ… æ­£ç¢º
interface InputData {
  value: number;
}

function process(data: InputData) {  // âœ…
  return data.value;
}
```

### éŒ¯èª¤ 4: Vue çµ„ä»¶é‚è¼¯éæ–¼è¤‡é›œ

```vue
<!-- âŒ éŒ¯èª¤: åœ¨çµ„ä»¶ä¸­å¯«å¤ªå¤šé‚è¼¯ -->
<script setup>
const data = ref([]);

// âŒ è¤‡é›œçš„é‚è¼¯æ‡‰è©²åœ¨ composable ä¸­
async function fetchData() {
  const response = await fetch('...');
  const json = await response.json();
  data.value = json.map(item => ({
    ...item,
    efficiency: calculateEfficiency(item)
  }));
}
</script>

<!-- âœ… æ­£ç¢º: ä½¿ç”¨ composable -->
<script setup>
import { usePowerData } from '@/composables/usePowerData';

const { data, loading, fetchData } = usePowerData();

onMounted(() => {
  fetchData('6001');
});
</script>
```

---

## ğŸ“‹ æª¢æŸ¥æ¸…å–® (Checklist)

### æ¯æ¬¡æäº¤å‰æª¢æŸ¥

- [ ] æ‰€æœ‰ TypeScript é¡å‹éƒ½æœ‰æ˜ç¢ºå®šç¾©ï¼Œæ²’æœ‰ä½¿ç”¨ `any`
- [ ] æ‰€æœ‰ async å‡½æ•¸éƒ½æœ‰éŒ¯èª¤è™•ç† (try-catch)
- [ ] éµå®ˆåˆ†å±¤æ¶æ§‹ï¼Œæ²’æœ‰è·¨å±¤å‘¼å«
- [ ] è®Šæ•¸å’Œå‡½æ•¸å‘½åç¬¦åˆè¦ç¯„
- [ ] æœ‰é©ç•¶çš„è¨»é‡‹å’Œ JSDoc
- [ ] é€šé ESLint æª¢æŸ¥ (`npm run lint`)
- [ ] é€šéæ‰€æœ‰æ¸¬è©¦ (`npm run test`)
- [ ] æ²’æœ‰ console.log (æ‡‰è©²ä½¿ç”¨ Logger)

### å‰µå»ºæ–°åŠŸèƒ½å‰æª¢æŸ¥

- [ ] é–±è®€ç›¸é—œçš„ Node-RED Function ç¯€é»ç¨‹å¼ç¢¼
- [ ] ç¢ºå®šæ‡‰è©²åœ¨å“ªä¸€å±¤å¯¦ä½œ (Controller/Service/Repository)
- [ ] æª¢æŸ¥æ˜¯å¦æœ‰é¡ä¼¼çš„ç¾æœ‰ç¨‹å¼ç¢¼å¯ä»¥åƒè€ƒ
- [ ] è¦åŠƒéœ€è¦çš„ TypeScript é¡å‹å®šç¾©
- [ ] è€ƒæ…®éŒ¯èª¤è™•ç†æƒ…æ³

### é‡æ§‹ç¨‹å¼ç¢¼å‰æª¢æŸ¥

- [ ] ç¢ºä¿æœ‰è¶³å¤ çš„æ¸¬è©¦è¦†è“‹
- [ ] ç¢ºèªé‡æ§‹ä¸æœƒå½±éŸ¿ç¾æœ‰åŠŸèƒ½
- [ ] ç¢ºèªå…¶ä»–é–‹ç™¼è€…åŒæ„é‡æ§‹æ–¹æ¡ˆ
- [ ] åˆ†æˆå°æ­¥é©Ÿé€²è¡Œï¼Œæ¯æ­¥éƒ½å¯ä»¥ç·¨è­¯å’Œæ¸¬è©¦

---

## ğŸ¯ é–‹ç™¼å„ªå…ˆé †åº

### Phase 1: å¾Œç«¯æ ¸å¿ƒé–‹ç™¼ âœ… **å·²å®Œæˆ**

1. **MQTT æœå‹™** âœ… **å·²å®Œæˆ**
   - âœ… `MqttService.ts` - MQTT é€£æ¥ç®¡ç†
   - âœ… `DataParser.ts` - æ•¸æ“šè§£æå™¨ (240 lines, 100% Node-RED parity)
   - âœ… `GpsParser.ts` - GPS è§£æå™¨ (130 lines)

2. **è³‡æ–™åº«æœå‹™** âœ… **å·²å®Œæˆ**
   - âœ… `DatabaseService.ts` - è³‡æ–™åº«é€£æ¥ (120 lines)
   - âœ… `PowerDataRepo.ts` - åŠŸç‡æ•¸æ“šå„²å­˜åº« (230 lines, UPSERT logic)
   - âœ… `GpsLocationRepo.ts` - GPS ä½ç½®å„²å­˜åº« (110 lines)
   - âœ… è³‡æ–™åº« Schema (6 tables, å®Œæ•´ indexes)

3. **æ¸¬è©¦å·¥å…·** âœ… **å·²å®Œæˆ**
   - âœ… `iot-simulator.ts` - IoT è¨­å‚™æ¨¡æ“¬å™¨ (500+ lines)
   - âœ… å®Œæ•´æ¸¬è©¦: 50+ power data records, 4 GPS records
   - âœ… 100% æ¸¬è©¦é€šéç‡

**Phase 1 æˆæœ**: [è©³ç´°å ±å‘Š](./IMPLEMENTATION_PHASE1_COMPLETE.md) | [æ¸¬è©¦çµæœ](./TEST_RESULTS_SUCCESS.md)

---

### Phase 2: API å±¤ + WebSocket (é€²è¡Œä¸­)

1. **API å±¤**
   - [ ] Routes + Controllers
   - [ ] API æ–‡æª” (Swagger)

2. **å³æ™‚æ¨é€æœå‹™**
   - [ ] `WebSocketService.ts` - WebSocket é€£æ¥
   - [ ] `UiFormatter.ts` - UI æ•¸æ“šæ ¼å¼åŒ–

### Phase 3: å‰ç«¯é–‹ç™¼

1. **æ ¸å¿ƒçµ„ä»¶**
   - [ ] PowerCard, EfficiencyCard
   - [ ] PowerChart, EfficiencyChart

2. **é é¢è¦–åœ–**
   - [ ] DashboardView
   - [ ] DeviceView

3. **ç‹€æ…‹ç®¡ç†**
   - [ ] Pinia Stores

### Phase 4: æ•´åˆèˆ‡æ¸¬è©¦

1. **æ•´åˆæ¸¬è©¦**
2. **ç«¯å°ç«¯æ¸¬è©¦**
3. **æ•ˆèƒ½æ¸¬è©¦**

### Phase 5: éƒ¨ç½²ä¸Šç·š

1. **Docker é…ç½®**
2. **CI/CD è¨­ç½®**
3. **ç›£æ§èˆ‡æ—¥èªŒ**

---

## ğŸ” é™¤éŒ¯æŒ‡å—

### å¾Œç«¯é™¤éŒ¯

```typescript
// âœ… ä½¿ç”¨ Logger è€Œé console.log
import { Logger } from '@/utils/logger';

const logger = new Logger('PowerDataService');

logger.info('Processing power data', { deviceId: '6001' });
logger.error('Failed to save data', { error: err.message });
logger.debug('Data parsed:', { parsedData });
```

### å‰ç«¯é™¤éŒ¯

```typescript
// âœ… ä½¿ç”¨ Vue DevTools
// å®‰è£: https://devtools.vuejs.org/

// âœ… ä½¿ç”¨ computed çš„ .value æª¢æŸ¥
console.log('Computed value:', myComputed.value);

// âœ… ä½¿ç”¨ watch è¿½è¹¤è®ŠåŒ–
watch(() => data.value, (newVal, oldVal) => {
  console.log('Data changed:', { newVal, oldVal });
});
```

---

## ğŸ†˜ é‡åˆ°å•é¡Œæ™‚

### æ­¥é©Ÿ 1: æª¢æŸ¥ç¾æœ‰è³‡æº

1. æŸ¥çœ‹ `CODING_STANDARDS.md` - ç¨‹å¼ç¢¼è¦ç¯„
2. æŸ¥çœ‹ `docs/` - ç›¸é—œæ–‡æª”
3. æŸ¥çœ‹å°ˆæ¡ˆä¸­é¡ä¼¼çš„ç¨‹å¼ç¢¼

### æ­¥é©Ÿ 2: åˆ†æå•é¡Œ

1. éŒ¯èª¤è¨Šæ¯æ˜¯ä»€éº¼?
2. åœ¨å“ªä¸€å±¤å‡ºç¾å•é¡Œ? (Controller/Service/Repository)
3. æ˜¯æ–°åŠŸèƒ½é‚„æ˜¯ä¿®æ”¹ç¾æœ‰åŠŸèƒ½?

### æ­¥é©Ÿ 3: æä¾›è§£æ±ºæ–¹æ¡ˆ

1. æä¾› 3-5 å€‹å¯èƒ½çš„ä¿®å¾©æ–¹æ¡ˆ
2. èªªæ˜æ¯å€‹æ–¹æ¡ˆçš„å„ªç¼ºé»
3. æ¨è–¦æœ€ä½³æ–¹æ¡ˆ

### æ­¥é©Ÿ 4: ç­‰å¾…ç”¨æˆ¶ç¢ºèª

**æ°¸é ä¸è¦**è‡ªå‹•ä¿®å¾©æˆ–å›æ»¾ï¼Œ**å¿…é ˆ**ç­‰å¾…ç”¨æˆ¶é¸æ“‡

---

## ğŸ“š é‡è¦åƒè€ƒè³‡æ–™

### å…§éƒ¨æ–‡æª”
- `README.md` - å°ˆæ¡ˆèªªæ˜
- `CODING_STANDARDS.md` - è©³ç´°ç¨‹å¼ç¢¼è¦ç¯„
- `docs/migration/node-red-to-nodejs.md` - é·ç§»æŒ‡å—

### å¤–éƒ¨è³‡æº
- [TypeScript å®˜æ–¹æ–‡æª”](https://www.typescriptlang.org/docs/)
- [Vue 3 å®˜æ–¹æ–‡æª”](https://vuejs.org/guide/)
- [Express.js æ–‡æª”](https://expressjs.com/)
- [Airbnb JavaScript Style Guide](https://github.com/airbnb/javascript)
- [PEP 8 (Python)](https://peps.python.org/pep-0008/)

---

## ğŸ“ çµ¦æœªä¾† Claude å¯¦ä¾‹çš„æé†’

**ç•¶ä½ æ¥æ‰‹é€™å€‹å°ˆæ¡ˆæ™‚ï¼Œè«‹å‹™å¿…:**

1. âœ… å…ˆé–±è®€æœ¬æª”æ¡ˆ (CLAUDE.md)
2. âœ… é–±è®€ README.md äº†è§£å°ˆæ¡ˆæ¦‚æ³
3. âœ… é–±è®€ CODING_STANDARDS.md äº†è§£è©³ç´°è¦ç¯„
4. âœ… æŸ¥çœ‹ `docs/migration/` äº†è§£å¾ Node-RED çš„é·ç§»é‚è¼¯
5. âœ… **è¨˜ä½**: æ°¸é ä¸è¦è‡ªå‹•å›æ»¾æˆ–ä¿®æ”¹ç¨‹å¼ç¢¼
6. âœ… **è¨˜ä½**: éµå®ˆåˆ†å±¤æ¶æ§‹ï¼Œä¸è¦è·¨å±¤å‘¼å«
7. âœ… **è¨˜ä½**: æ‰€æœ‰çš„ Node-RED Function éƒ½è¦è½‰æˆ TypeScript class/function

**é€™å€‹å°ˆæ¡ˆçš„æˆåŠŸå–æ±ºæ–¼:**
- æ¸…æ™°çš„æ¶æ§‹åˆ†å±¤
- ä¸€è‡´çš„ç¨‹å¼ç¢¼é¢¨æ ¼
- å®Œæ•´çš„éŒ¯èª¤è™•ç†
- å……åˆ†çš„æ¸¬è©¦è¦†è“‹

**ç¥é–‹ç™¼é †åˆ©! ğŸš€**

---

**è¨˜æ†¶æª”æ¡ˆç‰ˆæœ¬**: 1.1.0
**æœ€å¾Œæ›´æ–°**: 2025-11-13
**é©ç”¨éšæ®µ**: Phase 1 å®Œæˆ â†’ Phase 2 é–‹ç™¼ä¸­
**ç¶­è­·è€…**: SolarSDGs Development Team

---

## ğŸ“Š Phase 1 å®Œæˆçµ±è¨ˆ

**ç¨‹å¼ç¢¼é‡**:
- TypeScript Core: 710 lines (DataParser 240 + GpsParser 130 + Repositories 340)
- Architecture: 920 lines (Services + Database + Server)
- IoT Simulator: 500+ lines
- **ç¸½è¨ˆ**: ~2,130 lines

**åŠŸèƒ½å®Œæˆåº¦**:
- âœ… MQTT æ•¸æ“šæ¥æ”¶èˆ‡è§£æ: 100%
- âœ… è³‡æ–™åº«æ“ä½œ (UPSERT, queries): 100%
- âœ… Factor ä¿®æ­£ç³»çµ±: 100%
- âœ… GPS æ•¸æ“šè™•ç†: 100%
- âœ… Node-RED åŠŸèƒ½å°ç­‰: 100%

**æ¸¬è©¦çµæœ**:
- âœ… 50+ åŠŸç‡æ•¸æ“šè¨˜éŒ„
- âœ… 4 GPS ä½ç½®è¨˜éŒ„
- âœ… å»¶é² < 15ms
- âœ… æˆåŠŸç‡ 100%

