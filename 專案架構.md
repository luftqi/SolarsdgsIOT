
🌞 SolarSDGs IoT Platform - 完整專案文檔

文檔用途: 供 AI 助手快速理解專案全貌，延續對話上下文
最後更新: 2025-11-05
版本: v2.0 - Blynk to MQTT Migration


📋 專案摘要卡
yaml專案名稱: SolarSDGs 太陽能智慧監控平台
專案類型: 商用多租戶 IoT 系統
部署環境: 戶外太陽能供電 + 雲端 VPS
核心技術: Edge Computing + Time-Series DB + PWA
開發階段: 從 Blynk 遷移到自建系統

關鍵決策:
  ✅ 雙設備獨立架構（故障隔離）
  ✅ 文件系統存儲圖片（非資料庫）
  ✅ 每日僅上傳正午圖片（節省流量）
  ✅ 雙相機監控（RGB + 熱影像）
  ✅ 保留舊程式邏輯，僅替換通訊層
```

---

## 🏗️ 系統架構總覽

### **三層架構圖**
```
┌─────────────────────────────────────────────────────┐
│                邊緣層 (Edge Tier)                    │
│                  太陽能供電環境                       │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────────────────┐  ┌────────────────────┐  │
│  │   Pico2 W 主機       │  │  Pi Zero 2W 攝像機 │  │
│  │  (持續運作 24/7)     │  │  (間歇 10min/hour) │  │
│  ├──────────────────────┤  ├────────────────────┤  │
│  │ • RP2350 雙核        │  │ • BCM2710A1 4核    │  │
│  │ • 264KB RAM          │  │ • 512MB RAM        │  │
│  │ • INA226 x3 (I2C)    │  │ • IMX462 RGB相機   │  │
│  │ • SIM7080G 4G (UART) │  │ • 80x62 熱影像     │  │
│  │ • 1NCE SIM           │  │ • SIM7600G 4G      │  │
│  │ • 功耗: 60mA         │  │ • 1NCE SIM         │  │
│  │                      │  │ • 功耗: 110mA平均  │  │
│  │ 功能:                │  │ 功能:              │  │
│  │ - 讀取太陽能數據     │  │ - 每小時拍攝雙圖   │  │
│  │ - 計算效率           │  │ - 僅正午上傳雲端   │  │
│  │ - MQTT 上傳          │  │ - 本地存7天備份    │  │
│  │ - 每5分鐘更新        │  │ - 繼電器控制喚醒   │  │
│  └──────────────────────┘  └────────────────────┘  │
│            │ 4G-1                  │ 4G-2            │
└────────────┴───────────────────────┴─────────────────┘
             │                       │
             └───────────┬───────────┘
                         │ Internet
                         ↓
┌─────────────────────────────────────────────────────┐
│            應用層 (Application Tier)                 │
│          VPS: 31.97.71.140 (Docker)                 │
├─────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌──────────────┐  ┌────────────┐ │
│  │  Mosquitto  │  │  Node-RED    │  │ PostgreSQL │ │
│  │  MQTT       │  │  流程編排    │  │ TimescaleDB│ │
│  │  Port: 1883 │  │  Port: 1880  │  │ Port: 5432 │ │
│  └─────────────┘  └──────────────┘  └────────────┘ │
│         │                │                  │        │
│         └────────────────┴──────────────────┘        │
│                          │                           │
│                  ┌───────┴────────┐                  │
│                  │  Caddy Proxy   │                  │
│                  │  HTTPS/SSL     │                  │
│                  └────────────────┘                  │
└─────────────────────────────────────────────────────┘
                         │ HTTPS
                         ↓
┌─────────────────────────────────────────────────────┐
│             展示層 (Presentation Tier)               │
├─────────────────────────────────────────────────────┤
│         Dashboard 2.0 PWA (Vue.js 3)                │
│  • 即時數據圖表 (WebSocket)                          │
│  • 雙圖片並排顯示 (RGB + Thermal)                    │
│  • 響應式設計 (手機優先)                             │
│  • 離線可用 (Service Worker)                         │
│  • 多租戶隔離 (Role-based Access)                    │
└─────────────────────────────────────────────────────┘

🔌 硬體規格詳細清單
Pico2 W 太陽能監控主機
yaml主控板:
  型號: Raspberry Pi Pico2 W
  晶片: RP2350 (雙核 Cortex-M33 @ 150MHz)
  記憶體: 264KB SRAM + 2MB Flash
  無線: CYW43439 (WiFi + BLE) - 未使用 WiFi

功率感測器 (x3):
  型號: INA226
  介面: I2C (0x40, 0x41, 0x42)
  功能:
    - INA226-1 (0x40): PG 發電功率
    - INA226-2 (0x41): PA 負載A功率
    - INA226-3 (0x42): PP 負載P功率
  精度: ±0.1%
  範圍: 0-36V, ±20A

4G 模組:
  型號: SIMCom SIM7080G
  介面: UART (115200 baud)
  連接: GPIO 0 (TX), GPIO 1 (RX)
  頻段: LTE Cat-M1 / NB-IoT
  功耗: 睡眠 2mA / 傳輸 100mA

SIM 卡:
  供應商: 1NCE
  流量: 10MB/月 (10年有效期)
  月流量估算: 0.9MB (太陽能數據)

供電:
  電源: 5V DC from 太陽能充電控制器
  平均電流: 60mA
  日耗電: 1.44Ah
Pi Zero 2W 視覺監控機
yaml主控板:
  型號: Raspberry Pi Zero 2 W
  晶片: BCM2710A1 (四核 Cortex-A53 @ 1GHz)
  記憶體: 512MB LPDDR2
  存儲: 16GB microSD 卡

RGB 攝影機:
  品牌: 微雪 (Waveshare)
  感測器: Sony IMX462
  解析度: 1920x1080 (2MP)
  特殊功能: IR-CUT 紅外濾光切換
  低照度: 0.001 Lux
  介面: USB 或 CSI (待確認)
  連接: /dev/video0 或 CSI Port

熱影像模組:
  品牌: 微雪 (Waveshare)
  解析度: 80 x 62 像素
  溫度範圍: -20°C ~ 300°C (推測)
  介面: I2C 或 SPI (待確認)
  型號推測:
    - 可能是 MLX90640 系列
    - 或微雪自有模組
  輸出: 溫度矩陣數據

  ⚠️ 待確認資訊:
    - 具體型號（產品編號）
    - 通訊協議細節
    - Python 驅動庫
    - 現有程式碼實作方式

4G 模組:
  型號: Waveshare SIM7600G-H 4G HAT
  介面: USB 或 UART
  連接: /dev/ttyUSB2 (USB模式)
  頻段: LTE Cat-1
  功耗: 睡眠 5mA / 傳輸 150mA

SIM 卡:
  供應商: 1NCE
  流量: 10MB/月 (10年有效期)
  月流量估算: 2.1MB (每日1次圖片)

供電:
  電源: 5V DC (繼電器控制)
  工作電流: 450mA (拍照時)
  睡眠電流: 5mA
  日耗電: 1.9Ah (4h 工作 + 20h 睡眠)

控制機制:
  喚醒方式: Pico2 W 透過繼電器供電
  運作週期: 10分鐘/小時
  上傳策略: 僅正午12:00上傳

💾 數據模型設計
太陽能功率數據 (power_data)
sqlCREATE TABLE power_data (
    id BIGSERIAL PRIMARY KEY,
    device_id VARCHAR(10) NOT NULL,
    timestamp TIMESTAMP NOT NULL,

    -- 原始功率數據 (從 INA226 讀取)
    pg DECIMAL(10,2) NOT NULL,      -- 發電功率 (W)
    pa DECIMAL(10,2) NOT NULL,      -- 負載A功率 (W)
    pp DECIMAL(10,2) NOT NULL,      -- 負載P功率 (W)

    -- 效率數據 (邊緣計算)
    pag_efficiency DECIMAL(10,2),   -- 負載A效率 = (PA-PG)/PG * 100
    ppg_efficiency DECIMAL(10,2),   -- 負載P效率 = (PP-PG)/PG * 100

    -- 元數據
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 外鍵約束
    CONSTRAINT fk_device
        FOREIGN KEY (device_id)
        REFERENCES devices(device_id)
        ON DELETE CASCADE,

    -- 索引
    CONSTRAINT idx_unique_device_time
        UNIQUE (device_id, timestamp)
);

-- 高效能索引
CREATE INDEX idx_power_data_device_time
    ON power_data(device_id, timestamp DESC);

-- TimescaleDB 超表（時序優化）
SELECT create_hypertable('power_data', 'timestamp');

-- 自動清理策略（保留 90 天）
SELECT add_retention_policy('power_data', INTERVAL '90 days');

-- 連續聚合（預計算每小時平均值）
CREATE MATERIALIZED VIEW power_data_hourly
WITH (timescaledb.continuous) AS
SELECT
    device_id,
    time_bucket('1 hour', timestamp) AS hour,
    AVG(pg) AS avg_pg,
    AVG(pa) AS avg_pa,
    AVG(pp) AS avg_pp,
    AVG(pag_efficiency) AS avg_pag_eff,
    AVG(ppg_efficiency) AS avg_ppg_eff,
    MAX(pg) AS max_pg,
    MIN(pg) AS min_pg
FROM power_data
GROUP BY device_id, hour;

-- 數據量估算
-- 頻率: 5分鐘 = 288 筆/天
-- 單筆大小: ~100 bytes
-- 日增量: 28.8KB/設備
-- 90天: 2.6MB/設備
-- 100設備: 260MB
設備圖片數據 (device_images)
sqlCREATE TABLE device_images (
    id SERIAL PRIMARY KEY,
    device_id VARCHAR(10) NOT NULL,
    timestamp TIMESTAMP NOT NULL,

    -- RGB 可見光圖片
    rgb_image_base64 TEXT NOT NULL,
    rgb_size_kb DECIMAL(10,2),
    rgb_resolution VARCHAR(20) DEFAULT '800x600',

    -- 熱影像圖片
    thermal_image_base64 TEXT,
    thermal_size_kb DECIMAL(10,2),
    thermal_resolution VARCHAR(20) DEFAULT '640x480',
    thermal_temp_min DECIMAL(10,2),    -- 最低溫度 °C
    thermal_temp_max DECIMAL(10,2),    -- 最高溫度 °C

    -- 元數據
    type VARCHAR(50) DEFAULT 'noon_snapshot',
    upload_source VARCHAR(20) DEFAULT 'pizero2w',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 外鍵約束
    CONSTRAINT fk_device
        FOREIGN KEY (device_id)
        REFERENCES devices(device_id)
        ON DELETE CASCADE,

    -- 確保每設備每天只有一筆
    CONSTRAINT unique_device_date
        UNIQUE (device_id, DATE(timestamp))
);

-- 索引
CREATE INDEX idx_device_images_device_time
    ON device_images(device_id, timestamp DESC);

-- 自動清理（保留 30 天）
CREATE OR REPLACE FUNCTION cleanup_old_images()
RETURNS void AS $$
BEGIN
    DELETE FROM device_images
    WHERE timestamp < NOW() - INTERVAL '30 days';
END;
$$ LANGUAGE plpgsql;

-- Cron 定時執行
-- 在 pg_cron 或系統 cron 中設定每日執行

-- 數據量估算
-- 頻率: 1次/天 (僅正午)
-- RGB: 50KB, Thermal: 20KB
-- 單筆大小: ~70KB
-- 30天: 2.1MB/設備
-- 100設備: 210MB
設備主檔 (devices)
sqlCREATE TABLE devices (
    device_id VARCHAR(10) PRIMARY KEY,
    tenant_id INTEGER NOT NULL,
    device_name VARCHAR(100),
    device_type VARCHAR(50) DEFAULT 'solar_monitor',

    -- 硬體資訊
    hardware_version VARCHAR(20),
    firmware_version VARCHAR(20),

    -- SIM 卡資訊
    sim_iccid VARCHAR(20),
    sim_provider VARCHAR(50),

    -- 安裝資訊
    location_name VARCHAR(200),
    location_lat DECIMAL(10,7),
    location_lng DECIMAL(10,7),
    installation_date DATE,

    -- 校準參數（用於功率修正）
    calibration_factor_a DECIMAL(10,4) DEFAULT 1.0000,
    calibration_factor_p DECIMAL(10,4) DEFAULT 1.0000,

    -- 狀態
    status VARCHAR(20) DEFAULT 'active',
    last_seen TIMESTAMP,

    -- 元數據
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 外鍵
    CONSTRAINT fk_tenant
        FOREIGN KEY (tenant_id)
        REFERENCES tenants(tenant_id)
        ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_devices_tenant ON devices(tenant_id);
CREATE INDEX idx_devices_status ON devices(status);

🔄 MQTT 通訊協議
Topic 結構設計
yaml上行數據 (Device → Cloud):

  太陽能數據:
    Topic: solar/{device_id}/data
    QoS: 1 (至少一次送達)
    頻率: 每 5 分鐘
    Payload 範例:
      {
        "device_id": "6001",
        "timestamp": 1730800800,
        "pg": 150.25,
        "pa": 200.10,
        "pp": 180.50,
        "pag": 33.23,
        "ppg": 20.17
      }

  圖片數據:
    Topic: solar/{device_id}/image
    QoS: 1
    頻率: 每日 12:00
    Payload 範例:
      {
        "device_id": "6001",
        "timestamp": "2025-11-05T12:00:00Z",
        "type": "noon_snapshot",
        "rgb": {
          "image_base64": "iVBORw0KGgo...",
          "size_kb": 48.5,
          "resolution": "800x600"
        },
        "thermal": {
          "image_base64": "iVBORw0KGgo...",
          "size_kb": 18.2,
          "resolution": "640x480",
          "temp_min": 25.3,
          "temp_max": 62.8
        }
      }

下行指令 (Cloud → Device):

  通用指令:
    Topic: solar/{device_id}/cmd
    QoS: 1
    Payload 範例:
      {
        "action": "reboot",
        "timestamp": "2025-11-05T14:30:00Z"
      }

      {
        "action": "update_interval",
        "interval_seconds": 600
      }

      {
        "action": "calibrate",
        "factor_a": 1.0523,
        "factor_p": 0.9877
      }

狀態回報:
  Topic: solar/{device_id}/status
  QoS: 0 (盡力而為)
  頻率: 每小時 或 異常時
  Payload:
    {
      "device_id": "6001",
      "timestamp": "2025-11-05T14:30:00Z",
      "uptime_seconds": 86400,
      "free_memory_kb": 180,
      "signal_strength": -75,
      "battery_voltage": 12.6
    }

🔀 Blynk 遷移對照表
通訊層替換
python# ===== Blynk 舊架構 =====
import BlynkLib

AUTH_TOKEN = "your_blynk_token"
blynk = BlynkLib.Blynk(AUTH_TOKEN)

# 上傳數據
blynk.virtual_write(1, pg)    # V1: 發電功率
blynk.virtual_write(2, pa)    # V2: 負載A功率
blynk.virtual_write(3, pp)    # V3: 負載P功率
blynk.virtual_write(4, pag)   # V4: 效率A
blynk.virtual_write(5, ppg)   # V5: 效率P

# 接收指令
@blynk.on("V10")
def v10_write_handler(value):
    if value[0] == '1':
        # 執行某動作
        pass

# 主循環
while True:
    blynk.run()
    # 讀取感測器
    # ...
    time.sleep(0.05)


# ===== MQTT 新架構 =====
import paho.mqtt.client as mqtt
import json

MQTT_BROKER = "mqtt.alwaysbefound.com"
MQTT_PORT = 1883
DEVICE_ID = "6001"

# 連線
client = mqtt.Client()
client.connect(MQTT_BROKER, MQTT_PORT)

# 上傳數據（一次打包所有值）
payload = json.dumps({
    "device_id": DEVICE_ID,
    "timestamp": time.time(),
    "pg": pg,
    "pa": pa,
    "pp": pp,
    "pag": pag,
    "ppg": ppg
})
client.publish(f"solar/{DEVICE_ID}/data", payload, qos=1)

# 接收指令
def on_message(client, userdata, msg):
    cmd = json.loads(msg.payload)
    if cmd.get("action") == "某動作":
        # 執行某動作
        pass

client.subscribe(f"solar/{DEVICE_ID}/cmd")
client.on_message = on_message

# 主循環
while True:
    client.loop(timeout=0.05)
    # 讀取感測器
    # ...
    time.sleep(5)
Virtual Pin 映射表
yaml⚠️ 待用戶提供舊程式後補充

Blynk Virtual Pin  →  MQTT Topic/Field
─────────────────────────────────────
V1: 發電功率        →  solar/{id}/data → pg
V2: 負載A功率       →  solar/{id}/data → pa
V3: 負載P功率       →  solar/{id}/data → pp
V4: 效率A           →  solar/{id}/data → pag
V5: 效率P           →  solar/{id}/data → ppg
V10: 重啟指令       →  solar/{id}/cmd → {"action":"reboot"}
V11: ???            →  待確認
...                 →  待補充
